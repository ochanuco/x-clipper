name: TypeScript typecheck

on:
  pull_request:
    paths-ignore:
      - 'README.md'
      - 'AGENTS.md'

jobs:
  typecheck:
    runs-on: ubuntu-slim
    steps:
      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl ca-certificates gnupg
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Install dependencies
        run: pnpm install
      - name: Run typecheck
        run: |
          pnpm run typecheck | tee typecheck.log
      - name: Report typecheck result to PR
        if: always()
        uses: actions/github-script@v7
        env:
          RESULT: ${{ job.status }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const marker = '<!-- typecheck-report -->';
            const status = process.env.RESULT;
            const statusLabel = status === 'success'
              ? '✅ 成功'
              : status === 'failure'
                ? '❌ 失敗'
                : `⚠️ ${status}`;

            const issueNumber = context.payload.pull_request?.number;
            if (!issueNumber) {
              core.info('Pull request が見つかりませんでした。');
              return;
            }

            const params = { owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber };
            const comments = await github.paginate(github.rest.issues.listComments, params);
            const existing = comments.find((comment) => comment.body?.includes(marker));

            let logSnippet = '';
            if (fs.existsSync('typecheck.log')) {
              const content = fs.readFileSync('typecheck.log', 'utf8');
              const tail = content.slice(-3500);
              logSnippet = `\n\n<details><summary>出力ログ</summary>\n\n\`\`\`\n${tail}\n\`\`\`\n</details>`;
            }

            const body = `${marker}\n\n` +
              `## TypeScript typecheck 結果\n` +
              `- ステータス: ${statusLabel}\n` +
              `- ワークフロー実行: [${process.env.WORKFLOW_URL}](${process.env.WORKFLOW_URL})` +
              logSnippet;

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({ ...params, body });
            }
