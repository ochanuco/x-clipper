name: TypeScript typecheck

on:
  pull_request:
    paths-ignore:
      - 'README.md'
      - 'AGENTS.md'

jobs:
  typecheck:
    runs-on: ubuntu-slim
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl ca-certificates gnupg
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Install dependencies
        run: pnpm install
      - name: Run typecheck
        run: |
          set -o pipefail
          pnpm run typecheck | tee typecheck.log
      - name: Report typecheck result to PR
        if: always()
        uses: actions/github-script@v7
        env:
          RESULT: ${{ job.status }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const stripAnsi = (value) => value.replace(
              /[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,
              '',
            );
            const marker = '<!-- typecheck-report -->';
            const status = process.env.RESULT;
            const attempt = process.env.RUN_ATTEMPT || '1';
            const statusLabel = status === 'success'
              ? '✅ 成功'
              : status === 'failure'
                ? '❌ 失敗'
                : `⚠️ ${status}`;

            const log = fs.existsSync('typecheck.log')
              ? stripAnsi(fs.readFileSync('typecheck.log', 'utf8').trim())
              : 'ログが取得できませんでした。';

            const issueNumber = context.payload.pull_request?.number;
            if (!issueNumber) {
              core.info('Pull request が見つかりませんでした。');
              return;
            }

            const params = { owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber };
            const comments = await github.paginate(github.rest.issues.listComments, params);
            const existing = comments.find((comment) => comment.body?.includes(marker));

            const heading = `${marker}\n\n## TypeScript typecheck 結果履歴`;
            const previousBody = existing?.body ?? '';
            const previousEntries = previousBody.includes(heading)
              ? previousBody.slice(previousBody.indexOf(heading) + heading.length).trim()
              : '';

            const runLabel = `Run #${process.env.GITHUB_RUN_NUMBER}（試行 ${attempt}）`;
            const entry = `### ${runLabel}\n\n` +
              `| ステータス | ワークフロー |\n` +
              `| --- | --- |\n` +
              `| ${statusLabel} | [${process.env.WORKFLOW_URL}](${process.env.WORKFLOW_URL}) |\n\n` +
              `<details>\n<summary>実行ログを表示</summary>\n\n\`\`\`\n${log}\n\`\`\`\n\n</details>`;

            const body = `${heading}\n\n${entry}${previousEntries ? `\n\n${previousEntries}` : ''}`;

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({ ...params, body });
            }
